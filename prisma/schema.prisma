// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Authentication and account management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String?  // Hashed password
  accountId String
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  role      UserRole @default(ADMIN)
  // Link to groomer profile (for users with GROOMER role or solo groomers)
  groomerId String?
  groomer   Groomer? @relation(fields: [groomerId], references: [id], onDelete: SetNull)
  // Password reset
  passwordResetToken     String?   @unique
  passwordResetExpiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([groomerId])
}

enum UserRole {
  ADMIN
  GROOMER
  VIEWER
}

// Tenant / Business account
model Account {
  id              String            @id @default(cuid())
  name            String
  timezone        String            @default("America/New_York")
  // Subscription & Billing
  subscriptionPlan     SubscriptionPlan @default(TRIAL)
  billingCycle         BillingCycle     @default(MONTHLY)
  trialEndsAt          DateTime?        // 14 days from signup
  subscriptionStatus   SubscriptionStatus @default(TRIAL)
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?          @unique
  currentPeriodEnd     DateTime?
  lastActiveAt         DateTime?        // Track last user activity for analytics
  firstActionAt        DateTime?        // Track when first meaningful action occurred (for analytics)
  firstActionType      String?          // Type of first action: appointment_created, customer_created, route_optimized
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  users           User[]
  groomers        Groomer[]
  customers       Customer[]
  appointments    Appointment[]
  routes          Route[]
  messageTemplates MessageTemplate[]
  serviceAreas     ServiceArea[]
  areaDayAssignments AreaDayAssignment[]
  areaDateOverrides  AreaDateOverride[]
  teamInvitations    TeamInvitation[]

  // Pro plan seat tracking (populated from Stripe subscription metadata)
  adminSeats         Int              @default(1)  // Total admin seats purchased (min 1)
  groomerSeats       Int              @default(0)  // Total groomer seats purchased

  // Facebook tracking data (stored temporarily for CAPI event matching)
  fbTrackingData     Json?            // { fbc, fbp, userAgent, clientIp }

  // Google Calendar integration
  googleCalendarEnabled     Boolean @default(false)
  googleCalendarId          String?  // Calendar ID to sync to (usually "primary")
  googleAccessToken         String?  @db.Text
  googleRefreshToken        String?  @db.Text
  googleTokenExpiresAt      DateTime?

  @@index([createdAt])
  @@index([subscriptionStatus])
  @@index([trialEndsAt])
}

enum SubscriptionPlan {
  TRIAL
  STARTER
  GROWTH
  PRO
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  TRIAL           // Free 14-day trial
  ACTIVE          // Paid and active
  PAST_DUE        // Payment failed
  CANCELED        // User canceled
  INCOMPLETE      // Stripe subscription incomplete
  EXPIRED         // Trial expired, no payment
}

// Groomer (person/vehicle)
model Groomer {
  id                  String        @id @default(cuid())
  accountId           String
  account             Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  name                String
  email               String?
  phone               String?
  baseAddress         String
  baseLat             Float?
  baseLng             Float?
  geocodeStatus       GeocodeStatus @default(PENDING)
  workingHoursStart   String?       // HH:mm format
  workingHoursEnd     String?       // HH:mm format
  contactMethods      String[]      @default(["call", "sms"]) // call, sms, whatsapp, signal, telegram
  preferredMessaging  MessagingPreference @default(SMS) // SMS or WhatsApp for messaging buttons
  preferredMaps       MapsPreference @default(GOOGLE) // Google Maps or Apple Maps for navigation
  defaultHasAssistant Boolean       @default(false) // Default setting for working with a bather
  largeDogDailyLimit  Int?          // Max large/giant dogs per day (null = no limit)
  isActive            Boolean       @default(true)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  appointments        Appointment[]
  routes              Route[]
  breaks              Break[]
  areaDayAssignments  AreaDayAssignment[]
  areaDateOverrides   AreaDateOverride[]
  users               User[]        // Users linked to this groomer profile

  @@index([accountId])
  @@index([accountId, isActive])
}

enum MessagingPreference {
  SMS
  WHATSAPP
}

enum MapsPreference {
  GOOGLE
  APPLE
}

enum GeocodeStatus {
  PENDING
  OK
  PARTIAL
  FAILED
}

// Customer
model Customer {
  id                 String              @id @default(cuid())
  accountId          String
  account            Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  name               String
  email              String?
  phone              String?
  address            String
  city               String?
  state              String?
  zipCode            String?
  lat                Float?
  lng                Float?
  geocodeStatus      GeocodeStatus       @default(PENDING)
  // MVP Breakage Fix #1: Address validation & location intelligence
  addressNotes       String?             @db.Text // Gate codes, parking instructions
  accessInstructions String?             @db.Text // How to access property
  locationVerified   Boolean             @default(false) // Groomer confirmed on first visit
  notes              String?             @db.Text
  // Cancellation/No-show tracking
  cancellationCount  Int                 @default(0) // Total cancellations
  noShowCount        Int                 @default(0) // Total no-shows
  lastCancellationAt DateTime?           // When last cancelled
  lastNoShowAt       DateTime?           // When last no-showed
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  pets               Pet[]
  appointments       Appointment[]
  messages           Message[]
  waitlistEntries    CustomerWaitlist[]
  // Area Days - customer belongs to a service area
  serviceAreaId      String?
  serviceArea        ServiceArea? @relation(fields: [serviceAreaId], references: [id], onDelete: SetNull)

  @@index([accountId])
  @@index([accountId, createdAt])
  @@index([serviceAreaId])
}

// Pet
model Pet {
  id                String             @id @default(cuid())
  customerId        String
  customer          Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name              String
  breed             String?
  species           String?            // dog, cat, etc.
  weight            Float?             // in lbs or kg
  ageYears          Int?
  notes             String?            @db.Text
  groomingNotes     String?            @db.Text
  behaviorNotes     String?            @db.Text
  // MVP Breakage Fix #2: Behavior warnings & special handling
  behaviorFlags     BehaviorFlag[]
  equipmentRequired EquipmentRequired[]
  specialHandling   String?            @db.Text
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  appointments      Appointment[]

  @@index([customerId])
}

enum BehaviorFlag {
  FRIENDLY
  ANXIOUS
  AGGRESSIVE
  BITE_RISK
  MUZZLE_REQUIRED
}

enum EquipmentRequired {
  MUZZLE
  TABLE_EXTENDER
  HEAVY_DUTY_DRYER
  EXTRA_TOWELS
  SENSITIVE_SKIN_PRODUCTS
}

// Appointment
model Appointment {
  id              String            @id @default(cuid())
  accountId       String
  account         Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  groomerId       String
  groomer         Groomer           @relation(fields: [groomerId], references: [id], onDelete: Cascade)
  customerId      String
  customer        Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  petId           String?
  pet             Pet?              @relation(fields: [petId], references: [id], onDelete: SetNull)
  startAt         DateTime
  serviceMinutes  Int               @default(60)
  status          AppointmentStatus @default(BOOKED)
  appointmentType AppointmentType   @default(FULL_GROOM)
  earliestStart   DateTime?         // Optional time window
  latestEnd       DateTime?         // Optional time window
  notes           String?           @db.Text
  internalNotes   String?           @db.Text
  price           Float?
  // MVP Breakage Fix #3: Automated communication
  reminderSent24hr  Boolean @default(false)
  reminderSent2hr   Boolean @default(false)
  customerConfirmed Boolean @default(false)
  confirmedAt       DateTime?
  // Google Calendar sync
  googleCalendarEventId String?      // ID of synced Google Calendar event
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  routeStops      RouteStop[]
  messages        Message[]

  @@index([accountId])
  @@index([groomerId])
  @@index([customerId])
  @@index([accountId, groomerId, startAt])
  @@index([startAt])
}

enum AppointmentStatus {
  BOOKED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentType {
  FULL_GROOM
  BATH_ONLY
  BATH_BRUSH
  NAIL_TRIM
  FACE_FEET_FANNY
  DESHED
  PUPPY_INTRO
  HAND_STRIP
  CUSTOM
  SQUEEZE_IN // Quick service for filling gaps (MVP Breakage Fix #4)
  ADDON
}

// Route (daily driving plan)
model Route {
  id                  String                 @id @default(cuid())
  accountId           String
  account             Account                @relation(fields: [accountId], references: [id], onDelete: Cascade)
  groomerId           String
  groomer             Groomer                @relation(fields: [groomerId], references: [id], onDelete: Cascade)
  routeDate           DateTime               @db.Date // Date only
  startTime           DateTime?
  endTime             DateTime?
  totalDriveMinutes   Int?
  totalDistanceMeters Int?
  // MVP Breakage Fix #5: Route efficiency analytics
  totalServiceMinutes Int?
  efficiencyScore     Float?                 // 0-100, higher = better (work time / total time)
  estimatedGasCost    Float?
  hasAssistant        Boolean                @default(false) // Per-day override for working with bather
  workdayStarted      Boolean                @default(false) // User clicked "Start My Workday"
  status              RouteStatus            @default(DRAFT)
  provider            String?                // google | mapbox | custom
  polyline            String?                @db.Text // Encoded polyline for map display
  metadata            Json?                  // Store any additional provider response data
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  stops               RouteStop[]
  gapFillNotifications GapFillNotification[]

  @@unique([groomerId, routeDate])
  @@index([accountId])
  @@index([groomerId])
  @@index([groomerId, routeDate])
}

enum RouteStatus {
  DRAFT
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// RouteStop (individual stop in a route)
model RouteStop {
  id                     String       @id @default(cuid())
  routeId                String
  route                  Route        @relation(fields: [routeId], references: [id], onDelete: Cascade)
  appointmentId          String?
  appointment            Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  sequence               Int          // 1, 2, 3, etc.
  arrivalTime            DateTime?
  departureTime          DateTime?
  driveMinutesFromPrev   Int?
  distanceMetersFromPrev Int?
  stopType               StopType     @default(APPOINTMENT)
  address                String?      // For non-appointment stops
  lat                    Float?
  lng                    Float?
  notes                  String?      @db.Text
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  @@index([routeId])
  @@index([appointmentId])
  @@index([routeId, sequence])
}

enum StopType {
  START_BASE
  APPOINTMENT
  BREAK
  END_BASE
}

// MVP Breakage Fix #3: Messaging system
model Message {
  id             String       @id @default(cuid())
  accountId      String
  customerId     String
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  appointmentId  String?
  appointment    Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  messageType    MessageType
  content        String       @db.Text
  sentAt         DateTime     @default(now())
  deliveryStatus String?      // sent, delivered, failed
  errorMessage   String?

  @@index([accountId])
  @@index([customerId])
  @@index([appointmentId])
  @@index([sentAt])
}

enum MessageType {
  REMINDER_24HR
  REMINDER_2HR
  ON_MY_WAY
  RUNNING_LATE
  CONFIRMATION_REQUEST
  GAP_FILL_OFFER
  CUSTOM
}

model MessageTemplate {
  id        String      @id @default(cuid())
  accountId String
  account   Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  name      String      // "24hr Reminder", "On My Way", etc.
  type      MessageType
  content   String      @db.Text // Can include variables: {customerName}, {time}, {eta}
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([accountId])
  @@index([accountId, type])
}

// MVP Breakage Fix #4: Gap-fill system
model CustomerWaitlist {
  id             String   @id @default(cuid())
  accountId      String
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  preferredDays  String[] // ["MONDAY", "TUESDAY"]
  preferredTimes String[] // ["MORNING", "AFTERNOON"]
  flexibleTiming Boolean  @default(true)
  maxDistance    Int?     // Miles willing to travel from home
  notifyViaSMS   Boolean  @default(true)
  notifyViaEmail Boolean  @default(true)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([accountId])
  @@index([customerId])
  @@index([accountId, isActive])
}

model GapFillNotification {
  id             String   @id @default(cuid())
  accountId      String
  routeId        String
  route          Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
  gapStartTime   DateTime
  gapEndTime     DateTime
  customersSent  Int      @default(0)
  bookingsGained Int      @default(0)
  sentAt         DateTime @default(now())

  @@index([accountId])
  @@index([routeId])
}

// Break tracking for groomer wellness
model Break {
  id          String    @id @default(cuid())
  accountId   String
  groomerId   String
  groomer     Groomer   @relation(fields: [groomerId], references: [id], onDelete: Cascade)
  breakDate   DateTime  @db.Date // Date only
  startTime   DateTime? // Scheduled start time
  endTime     DateTime? // Scheduled end time
  breakType   BreakType @default(LUNCH)
  taken       Boolean   @default(false) // Was the break actually taken?
  takenAt     DateTime? // When the break was taken
  durationMinutes Int?  // Actual duration if taken
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([accountId])
  @@index([groomerId])
  @@index([groomerId, breakDate])
}

enum BreakType {
  LUNCH
  SHORT_BREAK
  HYDRATION
}

// Service area for "Area Days" feature - named groups for organizing customers by location
model ServiceArea {
  id          String   @id @default(cuid())
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name        String   // "North Side", "Downtown", "Westwood"
  color       String   // Hex color for UI display (#FF5733)

  // Areas are defined by which customers are assigned, not by geographic rules
  // The groomer manually assigns customers to areas based on their knowledge of the territory

  isActive    Boolean  @default(true)

  // Relationships
  dayAssignments AreaDayAssignment[]
  dateOverrides  AreaDateOverride[]
  customers      Customer[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([accountId])
  @@index([accountId, isActive])
}

// Day-of-week assignment for a groomer to a service area
model AreaDayAssignment {
  id          String      @id @default(cuid())
  accountId   String
  account     Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)

  groomerId   String
  groomer     Groomer     @relation(fields: [groomerId], references: [id], onDelete: Cascade)

  areaId      String
  area        ServiceArea @relation(fields: [areaId], references: [id], onDelete: Cascade)

  dayOfWeek   Int         // 0=Sunday, 1=Monday, 2=Tuesday, etc.

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([groomerId, dayOfWeek]) // One area per groomer per day
  @@index([accountId])
  @@index([groomerId])
  @@index([areaId])
}

// Date-specific area override (replaces default day-of-week assignment for a specific date)
model AreaDateOverride {
  id          String       @id @default(cuid())
  accountId   String
  account     Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  groomerId   String
  groomer     Groomer      @relation(fields: [groomerId], references: [id], onDelete: Cascade)

  date        DateTime     @db.Date  // Specific date (YYYY-MM-DD)

  // Area assignment for this date (null = day off / no area)
  areaId      String?
  area        ServiceArea? @relation(fields: [areaId], references: [id], onDelete: SetNull)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([groomerId, date])  // One override per groomer per date
  @@index([accountId])
  @@index([groomerId, date])
  @@index([areaId])
}

// Team Invitation for Pro plan seat management
model TeamInvitation {
  id          String           @id @default(cuid())
  accountId   String
  account     Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)

  email       String           // Email address to invite
  role        UserRole         @default(GROOMER) // Role to assign when accepted
  invitedBy   String           // User ID who sent the invitation

  token       String           @unique // Unique token for invitation link
  expiresAt   DateTime         // When the invitation expires
  status      InvitationStatus @default(PENDING)

  acceptedAt  DateTime?        // When the invitation was accepted
  acceptedBy  String?          // User ID who accepted (after they create account)

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([accountId])
  @@index([token])
  @@index([email])
  @@index([status])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// Admin audit log for tracking important system events
model AdminEvent {
  id          String   @id @default(cuid())
  type        String   // signup, subscription_change, payment, login, etc.
  accountId   String?  // Related account (if applicable)
  accountName String?  // Snapshot of account name at time of event
  userId      String?  // Related user (if applicable)
  userEmail   String?  // Snapshot of user email at time of event
  description String   // Human-readable description
  metadata    Json?    // Additional event-specific data
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([accountId])
  @@index([createdAt])
}
